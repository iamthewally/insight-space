<!DOCTYPE html>
<html>
<head>
    <title>Real-Time Transcription</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        #status {
            color: red;
        }
        .connected {
            color: green;
        }
    </style>
</head>
<body>
    <h1>Real-Time Transcription with Whisper</h1>
    <button id="startButton" onclick="startRecording()">Start Recording</button>
    <button id="stopButton" onclick="stopRecording()" disabled>Stop Recording</button>
    <div id="status">Not Connected</div>
    <div id="transcription"></div>

    <script>
        var socket = io();
        var mediaRecorder;
        var intervalId;

        socket.on('connect', function () {
            console.log('Connected to server.');
            document.getElementById('status').innerText = 'Connected';
            document.getElementById('status').classList.add('connected');
        });

        socket.on('disconnect', function () {
            document.getElementById('status').innerText = 'Disconnected';
            document.getElementById('status').classList.remove('connected');
            clearInterval(intervalId); // Clear the interval if the socket gets disconnected
        });

        socket.on('transcription', function (data) {
            console.log("Received transcription event:", data);
            if (data && data.text) {
                document.getElementById('transcription').innerText += data.text + ' ';
            }
        });

        socket.on('error', function (data) {
            document.getElementById('transcription').innerText += 'Error: ' + data.message + ' ';
            document.getElementById('status').innerText = 'Error occurred';
        });
        function startRecording() {
            // Request the browser to capture audio with specific constraints
    navigator.mediaDevices.getUserMedia({
        audio: {
            sampleRate: 16000 // Attempt to set the sample rate to 16000 Hz
        }
    }).then(stream => {
            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;

            let mimeTypeOption = "audio/mp4";
            if(!MediaRecorder.isTypeSupported('audio/mp4')){
                mimeTypeOption = 'audio/webm;codecs=opus';
            }
            mediaRecorder = new MediaRecorder(stream, {mimeType: mimeTypeOption});

            console.log("Using mimeType: " + mimeTypeOption);
            mediaRecorder.ondataavailable = function (event) {
                if (event.data.size > 0) {
                    sendAudioData(event.data);
                }
            };

            // Start recording without slicing the audio blob
            mediaRecorder.start();

            // Automatically stop recording after 10 seconds
            setTimeout(function() {
                stopRecording();
            }, 10000); // 10000 milliseconds = 10 seconds

            console.log("MediaRecorder started");
        })
        .catch(function (err) {
            console.error('Error starting audio recording:', err);
            document.getElementById('transcription').innerText = 'Recording failed: ' + err.message;
        });
}
        function sendAudioData(audioBlob) {
            var reader = new FileReader();
            reader.onload = function () {
                socket.emit('audio_chunk', reader.result);
            };
            reader.readAsArrayBuffer(audioBlob);
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('startButton').disabled = false;
                document.getElementById('stopButton').disabled = true;
                document.getElementById('transcription').innerText += '\nRecording stopped. ';
            }
        }
    </script>
</body>
</html>
